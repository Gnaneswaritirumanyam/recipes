<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ratings & Reviews</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>

  body {
  font-family: Arial, sans-serif;
  background: url('/static/images/review.jpg') no-repeat center center fixed;
  background-size: cover; /* make image cover the entire page */
  margin: 0;
  padding: 0;
}
  .review-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 20px;
    padding: 20px;
  }
  .card {
    border-radius: 15px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  }
  .rating-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 5px 0;
  }
  .bar {
    background: #e4e4e4;
    height: 10px;
    flex: 1;
    border-radius: 5px;
    overflow: hidden;
  }
  .bar-fill {
    background: #ff9800;
    height: 100%;
    width: 0%;
    transition: width 0.5s ease;
  }
  .review-item {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
  }
  .stars i {
    color:#ff9800;
  }
  textarea { resize: none; }
/* Orange buttons */
.btn-primary {
  background-color: #ff6700;
  border-color: #ff6700;
  color: #fff;
}

.btn-primary:hover,
.btn-primary:focus {
  background-color: #e65a00;
  border-color: #e65a00;
  color: #fff;
}

.btn-outline-primary {
  color: #ff6700;
  border-color: #ff6700;
}

.btn-outline-primary:hover {
  background-color: #ff6700;
  color: #fff;
}

.btn-outline-secondary {
  color: #ff6700;
  border-color: #ff6700;
}

.btn-outline-secondary:hover {
  background-color: #ff6700;
  color: #fff;
}
.stars i {
  color: #ff6700; /* deep orange color */
}
#starRating i:hover,
#starRating i:hover ~ i {
  color: #ff6700;
}

/* Glassy effect for all cards and containers */
.card {
  background: rgba(255, 255, 255, 0.22);             /* semi-transparent */
  backdrop-filter: saturate(180%) blur(14px);        /* frosted glass blur */
  -webkit-backdrop-filter: saturate(180%) blur(14px);
  border-radius: 20px;                               /* rounded corners */
  padding: 2rem;                                     /* internal spacing */
  box-shadow: 0 0 50px rgba(0, 0, 0, 0.25);         /* subtle shadow */
  border: 1px solid rgba(255, 255, 255, 0.18);      /* faint border */
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Optional hover effect for cards */
.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0 60px rgba(0, 0, 0, 0.3);
}


/* ===== Responsive Layout Fix ===== */

/* Tablet and below (≤ 992px): stack the cards vertically */
@media (max-width: 992px) {
  .review-container {
    grid-template-columns: 1fr;
    padding: 15px;
  }
}

/* Mobile (≤ 576px): tighter layout, smaller text */
@media (max-width: 576px) {
  body {
    background-size: cover;
    background-attachment: scroll; /* prevents zoom jump on phones */
  }

  .review-container {
    grid-template-columns: 1fr;
    gap: 15px;
    padding: 10px;
  }

  .card {
    padding: 1.2rem;
    border-radius: 15px;
  }

  .card h5 {
    font-size: 1rem;
  }

  .card h1 {
    font-size: 1.8rem;
  }

  .rating-bar {
    font-size: 0.9rem;
  }

  .stars i {
    font-size: 1.2rem;
  }

  .btn,
  #submitBtn {
    font-size: 0.9rem;
    padding: 8px 12px;
  }

  textarea, input {
    font-size: 0.9rem;
  }

  .d-flex.justify-content-center.align-items-center.mb-4.position-relative h2 {
    font-size: 1.4rem;
  }

  /* Back button size adjust */
  a.btn.me-3.position-absolute.start-0 {
    font-size: 0.85rem;
    padding: 6px 10px;
  }
}

</style>
</head>
<body>


<div class="container mt-4">
 <div class="d-flex justify-content-center align-items-center mb-4 position-relative">
  <a href="/dashboard" class="btn me-3 position-absolute start-0" style="background-color: orange; color: white;">
  <i class="bi bi-arrow-left"></i> Back
</a>

  <h2 class="mb-0 text-center" style="color: orangered;">⭐ Ratings & Reviews</h2>
</div>

  <div class="review-container">
    <!-- Ratings Breakdown -->
    <div class="card p-4">
      <h5>Ratings Breakdown</h5>
      <ul class="list-unstyled m-0">
        <li class="rating-bar">5 ★ <div class="bar"><div class="bar-fill" id="bar5"></div></div><span id="count5">0</span></li>
        <li class="rating-bar">4 ★ <div class="bar"><div class="bar-fill" id="bar4"></div></div><span id="count4">0</span></li>
        <li class="rating-bar">3 ★ <div class="bar"><div class="bar-fill" id="bar3"></div></div><span id="count3">0</span></li>
        <li class="rating-bar">2 ★ <div class="bar"><div class="bar-fill" id="bar2"></div></div><span id="count2">0</span></li>
        <li class="rating-bar">1 ★ <div class="bar"><div class="bar-fill" id="bar1"></div></div><span id="count1">0</span></li>
      </ul>
    </div>

    <!-- Average Rating -->
    <div class="card text-center p-4">
      <h5>Average Rating</h5>
      <h1 id="avgRating">0.0</h1>
      <div id="avgStars" class="stars"></div>
    </div>

    <!-- Reviews List -->
    <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Reviews</h5>
        <div>
          <button class="btn btn-sm btn-outline-primary" id="btnLatest">Latest</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnAll">All</button>
        </div>
      </div>
      <div id="reviewList"></div>
    </div>

    <!-- Add Review -->
    <div class="card p-4">
      <h5>Add Your Review</h5>
      <div class="mb-3"><label>Name</label><input type="text" id="name" class="form-control" placeholder="Your name"></div>
      <div class="mb-3"><label>Email</label><input type="email" id="email" class="form-control" placeholder="Your email"></div>
      <div class="mb-3">
        <label>Rating</label>
        <div id="starRating" class="stars" style="font-size:1.5rem; cursor:pointer; ">
          <i class="bi bi-star" data-value="1"></i>
          <i class="bi bi-star" data-value="2"></i>
          <i class="bi bi-star" data-value="3"></i>
          <i class="bi bi-star" data-value="4"></i>
          <i class="bi bi-star" data-value="5"></i>
        </div>
      </div>
      <div class="mb-3"><label>Your Review</label><textarea id="review" rows="3" class="form-control" placeholder="Write something..."></textarea></div>
      <button class="btn btn-primary w-100" id="submitBtn">Submit Review</button>
      <div class="alert alert-success mt-3 text-center" id="successMsg" hidden>✅ Review submitted successfully!</div>
    </div>
  </div>
</div>

<script>
const API_URL = "/api/reviews"; // must match backend
let allReviews = [];
let selectedRating = 0;
const stars = document.querySelectorAll("#starRating i");

// Load reviews
async function loadReviews() {
  try {
    const res = await fetch(API_URL);
    allReviews = await res.json();
    updateStats(allReviews);
    showLatest();
  } catch(err) { console.error(err); }
}

// Update bars & average
function updateStats(data) {
  const total = data.length;
  if(!total) return;

  const avg = (data.reduce((sum,r)=>sum+r.rating,0)/total).toFixed(1);
  document.getElementById('avgRating').textContent = avg;
  renderStars(document.getElementById('avgStars'), Math.round(avg));

  const histogram = {1:0,2:0,3:0,4:0,5:0};
  data.forEach(r=>histogram[r.rating]++);
  for(let i=1;i<=5;i++){
    const pct = (histogram[i]/total)*100;
    document.getElementById('bar'+i).style.width = pct+'%';
    document.getElementById('count'+i).textContent = histogram[i];
  }
}

// Render stars
function renderStars(container,rating){
  container.innerHTML='';
  for(let i=1;i<=5;i++){
    container.innerHTML += `<i class="bi ${i<=rating?'bi-star-fill':'bi-star'}"></i>`;
  }
}

// Display reviews
function displayReviews(list){
  const container = document.getElementById('reviewList');
  container.innerHTML='';
  list.forEach(r=>{
    const date = new Date(r.createdAt).toLocaleString();
    container.innerHTML+=`
      <div class="review-item">
        <strong>${r.name}</strong> <small class="text-muted">${date}</small><br>
        ${'⭐'.repeat(r.rating)} 
        <p>${r.review}</p>
      </div>`;
  });
}

// Latest & All
function showLatest(){ displayReviews(allReviews.slice(0,5)); }
function showAll(){ displayReviews(allReviews); }

// Star selection
stars.forEach(star=>{
  star.addEventListener('click',()=>{
    selectedRating = parseInt(star.dataset.value);
    stars.forEach(s=>{
      s.classList.remove("bi-star-fill","bi-star");
      s.classList.add(parseInt(s.dataset.value)<=selectedRating?"bi-star-fill":"bi-star");
    });
  });
});

// Submit review
document.getElementById('submitBtn').onclick = async ()=>{
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const review = document.getElementById('review').value.trim();

  if(!name||!email||!selectedRating||!review){ alert("Please fill all fields!"); return; }

  try{
    const res = await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,email,rating:selectedRating,review})
    });
    if(!res.ok) throw new Error("Failed to submit review");
    const data = await res.json();

    allReviews.unshift({
      _id: data.id,
      name,email,rating:selectedRating,review,
      createdAt: new Date().toISOString()
    });

    updateStats(allReviews);
    showLatest();

    document.getElementById('successMsg').hidden=false;
    setTimeout(()=>document.getElementById('successMsg').hidden=true,3000);

    // Clear form
    document.getElementById('name').value='';
    document.getElementById('email').value='';
    document.getElementById('review').value='';
    selectedRating=0;
    stars.forEach(s=>{ s.classList.remove("bi-star-fill"); s.classList.add("bi-star"); });

  }catch(err){ console.error(err); alert("Error submitting review"); }
};

// Init
document.getElementById('btnLatest').onclick=showLatest;
document.getElementById('btnAll').onclick=showAll;
loadReviews();
let signedInEmail = ""; // get this from your authentication system

// Example: after login
signedInEmail = user.email; // populate this when user signs in

document.getElementById('submitBtn').onclick = async ()=> {
  if(!signedInEmail){
    alert("Please sign in with your registered email to submit a review.");
    return;
  }
  
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();

  if(email !== signedInEmail){
    alert("You can only submit reviews with your signed-up email.");
    return;
  }

  // ...rest of your existing submit logic
};

</script>
</body>
</html>
